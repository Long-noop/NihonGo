<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N3 Kanji Flashcards - 521 H√°n T·ª±</title>

    <!-- Google Fonts - Japanese -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Hanzi Writer for Kanji Animation -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

    <link rel="stylesheet" href="./asserts/styles.css" />
    <style>
      :root {
        --font-sans: "Noto Sans JP", sans-serif;
        --font-serif: "Noto Serif JP", serif;
        --font-family: var(--font-sans);
        --front-gradient: linear-gradient(135deg, #ffffff 0%, #ffeaa7 100%);
        --back-gradient: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        --btn-accent: #e74c3c;
        --home-btn-bg: #2563eb;
        --home-btn-bg-hover: #1d4ed8;
      }

      /* Animation wrapper */
      .kanji-animation-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      #kanji-animation {
        background: white;
        border-radius: 15px;
        /* padding: 2px; */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .animation-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .anim-btn {
        padding: 10px 20px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        font-family: var(--font-sans);
      }

      .anim-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .anim-btn:active {
        transform: translateY(0);
      }

      .anim-btn.active {
        background: #48bb78;
        color: white;
        border-color: #48bb78;
      }

      /* kanji-specific styles */
      .kanji-display {
        font-size: 12em;
        font-weight: bold;
        color: #e74c3c;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
        font-family: var(--font-serif);
        display: none; /* Hidden by default, use animation */
      }

      .han-viet {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 20px;
        border-bottom: 3px solid rgba(255, 255, 255, 0.5);
        padding-bottom: 15px;
        font-family: var(--font-sans);
      }

      .meaning {
        font-size: 1.8em;
        margin-bottom: 25px;
        font-style: italic;
        font-weight: 300;
      }

      .example {
        font-size: 1.4em;
        font-family: var(--font-sans);
      }

      @media (max-width: 768px) {
        #kanji-animation {
          padding: 15px;
        }

        .anim-btn {
          padding: 8px 15px;
          font-size: 12px;
        }
      }

      @media (max-width: 600px) {
        .kanji-display {
          font-size: 8em;
        }
        .han-viet {
          font-size: 2em;
        }
        .meaning {
          font-size: 1.4em;
        }
        .example {
          font-size: 1.2em;
        }
        .flashcard {
          height: 450px;
        }

        #kanji-animation {
          padding: 10px;
        }
      }

      @media (max-width: 480px) {
        .kanji-animation-wrapper {
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìù JLPT N3 Kanji Flashcards</h1>
        <p>521 H√°n T·ª± C·∫ßn Thi·∫øt</p>
      </div>

      <div class="card-container">
        <div class="flashcard" id="flashcard">
          <div class="card-face card-front">
            <!-- Animation Wrapper -->
            <div class="kanji-animation-wrapper">
              <svg id="kanji-animation" width="250" height="250"></svg>

              <!-- Animation Controls -->
              <div class="animation-controls">
                <!-- <button class="anim-btn" onclick="animateKanji(event)">
                  ‚ñ∂Ô∏è Animate
                </button> -->
                <button
                  class="anim-btn"
                  onclick="toggleAutoLoop(event)"
                  id="autoLoopBtn"
                >
                  üîÅ Animate
                </button>
              </div>
            </div>

            <!-- Fallback: Static Display -->
            <div class="kanji-display" id="kanji-static">Ë≠∑</div>
          </div>
          <div class="card-face card-back">
            <div class="han-viet" id="han-viet">H·ªò</div>
            <div class="meaning" id="meaning">B·∫£o v·ªá, che ch·ªü</div>
            <div class="example" id="example">
              ÁúãË≠∑Â∏´ („Åã„Çì„Åî„Åó)<br />
              Y t√°
            </div>
            <div class="audio-buttons">
              <button
                class="btn-speak"
                onclick="speakKanjiExample(event)"
                title="ƒê·ªçc t·ª´ v√≠ d·ª• (ch·ªâ ti·∫øng Nh·∫≠t)"
              >
                üîä Nghe
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-prev" onclick="previousCard()">‚óÄ Tr∆∞·ªõc</button>
        <button class="btn btn-flip" onclick="flipCard()">üîÑ L·∫≠t</button>
        <button class="btn btn-next" onclick="nextCard()">Sau ‚ñ∂</button>
      </div>

      <div class="progress">
        <div class="bar">
          <span id="current-card">1</span> / <span id="total-cards">521</span>
        </div>
      </div>

      <div class="flip-hint">
        üí° Nh·∫•p v√†o th·∫ª ho·∫∑c nh·∫•n Spacebar ƒë·ªÉ l·∫≠t | ‚Üê ‚Üí ƒë·ªÉ chuy·ªÉn th·∫ª | A ƒë·ªÉ
        Animate | L ƒë·ªÉ Loop
      </div>
    </div>

    <a href="index.html" class="home-btn">üè† Home</a>

    <style>
      .home-btn {
        position: fixed;
        bottom: 80px;
        right: 25px;
        background-color: #2563eb;
        color: white;
        padding: 12px 18px;
        border-radius: 50px;
        text-decoration: none;
        font-size: 15px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: 0.3s ease;
        z-index: 1000;
      }

      .home-btn:hover {
        background-color: #1d4ed8;
        transform: translateY(-3px);
      }
    </style>

    <script src="./data/tts.js"></script>
    <script src="./data/tts.js"></script>
    <script>
      let allKanji = [];
      let currentIndex = 0;
      let writer = null;
      let autoLoop = false;
      let loopInterval = null;

      // Load Kanji Animation with Hanzi Writer
      function loadKanjiAnimation(character) {
        const target = document.getElementById("kanji-animation");

        // Clear previous writer
        if (writer) {
          writer = null;
        }

        // Clear any existing loop
        if (loopInterval) {
          clearInterval(loopInterval);
          loopInterval = null;
        }

        // Clear SVG
        target.innerHTML = "";

        try {
          // Create new Hanzi Writer instance
          writer = HanziWriter.create(target, character, {
            width: 250,
            height: 250,
            padding: 20,
            strokeColor: "#e74c3c",
            strokeAnimationSpeed: 1.2,
            delayBetweenStrokes: 120,
            showOutline: true,
            showCharacter: false,
            radicalColor: "#168eea",
            strokeFadeDuration: 400,
          });

          console.log("‚úÖ Loaded Kanji:", character);

          // Auto-animate if auto loop is on
          if (autoLoop) {
            startAutoLoop();
          }
        } catch (error) {
          console.error("‚ùå Error loading kanji:", error);
          // Fallback to static display
          const staticEl = document.getElementById("kanji-static");
          staticEl.textContent = character;
          staticEl.style.display = "block";
          target.style.display = "none";
        }
      }

      // Animate Kanji stroke order
      function animateKanji(event) {
        if (event) event.stopPropagation();

        if (!writer) {
          console.log("No writer instance");
          return;
        }

        writer.showCharacter();
        setTimeout(() => {
          writer.animateCharacter({
            onComplete: function () {
              console.log("Animation complete");
            },
          });
        }, 100);
      }

      // Toggle Auto Loop
      function toggleAutoLoop(event) {
        if (event) event.stopPropagation();

        autoLoop = !autoLoop;
        const btn = document.getElementById("autoLoopBtn");

        if (autoLoop) {
          btn.classList.add("active");
          btn.textContent = "‚è∏Ô∏è Stop";
          startAutoLoop();
        } else {
          btn.classList.remove("active");
          btn.textContent = "üîÅ Animate";
          stopAutoLoop();
        }
      }

      // Start auto loop animation
      function startAutoLoop() {
        if (!writer) return;

        // Clear any existing interval
        if (loopInterval) {
          clearInterval(loopInterval);
        }

        // Initial animation
        animateKanji(null);

        // Set interval to repeat
        // Calculate total animation time: ~200ms per stroke average + delays
        const avgStrokesPerKanji = 30; // Average estimate
        const animationTime = avgStrokesPerKanji * 200 + 2000; // Add buffer

        loopInterval = setInterval(() => {
          animateKanji(null);
        }, animationTime);
      }

      // Stop auto loop
      function stopAutoLoop() {
        if (loopInterval) {
          clearInterval(loopInterval);
          loopInterval = null;
        }
      }

      // Function to speak only Japanese part of example
      function speakKanjiExample(event) {
        event.stopPropagation();

        const exampleHTML = document.getElementById("example").innerHTML;
        const japaneseOnly = extractJapaneseOnly(exampleHTML);
        if (japaneseOnly) {
          speakJapanese(japaneseOnly, 0.85);
        }
      }

      // Load d·ªØ li·ªáu t·ª´ file JSON
      async function loadKanjiData() {
        try {
          const response = await fetch("./data/kanji.json");
          allKanji = await response.json();
          document.getElementById("total-cards").textContent = allKanji.length;
          updateCard();
        } catch (error) {
          console.error("Error loading kanji data:", error);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra file kanji.json");
        }
      }

      function updateCard() {
        if (allKanji.length === 0) return;

        const card = allKanji[currentIndex];

        // Update back side
        document.getElementById("han-viet").textContent = card.han_viet;
        document.getElementById("meaning").textContent = card.meaning;
        document.getElementById("example").innerHTML = card.example.replace(
          " - ",
          "<br>",
        );
        document.getElementById("current-card").textContent = currentIndex + 1;

        // Load kanji animation on front side
        loadKanjiAnimation(card.kanji);

        // Update static fallback
        document.getElementById("kanji-static").textContent = card.kanji;

        // Reset flip
        document.getElementById("flashcard").classList.remove("flipped");
      }

      function flipCard() {
        document.getElementById("flashcard").classList.toggle("flipped");
      }

      function nextCard() {
        currentIndex = (currentIndex + 1) % allKanji.length;
        updateCard();
      }

      function previousCard() {
        currentIndex = (currentIndex - 1 + allKanji.length) % allKanji.length;
        updateCard();
      }

      // Click to flip (but not on animation controls)
      document
        .getElementById("flashcard")
        .addEventListener("click", function (e) {
          // Don't flip if clicking animation controls or SVG
          if (
            e.target.closest(".animation-controls") ||
            e.target.closest("#kanji-animation")
          ) {
            return;
          }
          flipCard();
        });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Spacebar") {
          e.preventDefault();
          flipCard();
        } else if (e.key === "ArrowLeft") {
          previousCard();
        } else if (e.key === "ArrowRight") {
          nextCard();
        } else if (e.key === "a" || e.key === "A") {
          animateKanji(new Event("click"));
        } else if (e.key === "l" || e.key === "L") {
          toggleAutoLoop(new Event("click"));
        }
      });

      // Load data when page loads
      loadKanjiData();
    </script>
  </body>
</html>
