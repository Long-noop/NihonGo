<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JLPT N3 Kanji Flashcards - 521 H√°n T·ª±</title>

    <!-- Google Fonts - Japanese -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Using local KanjiVG SVGs for animations (no HanziWriter CDN) -->

    <link rel="stylesheet" href="./asserts/styles.css" />
    <style>
      :root {
        --font-sans: "Noto Sans JP", sans-serif;
        --font-serif: "Noto Serif JP", serif;
        --font-family: var(--font-sans);
        --front-gradient: linear-gradient(135deg, #ffffff 0%, #ffeaa7 100%);
        --back-gradient: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        --btn-accent: #e74c3c;
        --home-btn-bg: #2563eb;
        --home-btn-bg-hover: #1d4ed8;
      }

      /* Animation wrapper */
      .kanji-animation-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      #kanji-animation {
        background: white;
        border-radius: 15px;
        /* padding: 2px; */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .kanji-svg svg text {
        opacity: 0 !important;
      }

      .animation-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .anim-btn {
        padding: 10px 20px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        font-family: var(--font-sans);
      }

      .anim-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .anim-btn:active {
        transform: translateY(0);
      }

      .anim-btn.active {
        background: #48bb78;
        color: white;
        border-color: #48bb78;
      }

      /* kanji-specific styles */
      .kanji-display {
        font-size: 12em;
        font-weight: bold;
        color: #e74c3c;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
        font-family: var(--font-serif);
        display: none; /* Hidden by default, use animation */
      }

      .han-viet {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 20px;
        border-bottom: 3px solid rgba(255, 255, 255, 0.5);
        padding-bottom: 15px;
        font-family: var(--font-sans);
      }

      .meaning {
        font-size: 1.8em;
        margin-bottom: 25px;
        font-style: italic;
        font-weight: 300;
      }

      .example {
        font-size: 1.4em;
        font-family: var(--font-sans);
      }

      @media (max-width: 768px) {
        #kanji-animation {
          padding: 15px;
        }

        .anim-btn {
          padding: 8px 15px;
          font-size: 12px;
        }
      }

      @media (max-width: 600px) {
        .kanji-display {
          font-size: 8em;
        }
        .han-viet {
          font-size: 2em;
        }
        .meaning {
          font-size: 1.4em;
        }
        .example {
          font-size: 1.2em;
        }
        .flashcard {
          height: 450px;
        }

        #kanji-animation {
          padding: 10px;
        }
      }

      @media (max-width: 480px) {
        .kanji-animation-wrapper {
          gap: 15px;
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        animation: fadeIn 0.3s;
      }

      .modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
        text-align: center;
      }

      .modal-content h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 2em;
      }

      .modal-content p {
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .kanji-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .kanji-option {
        padding: 20px 30px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 1.2em;
        font-weight: bold;
        color: white;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .kanji-option:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .kanji-option.n3 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .kanji-option.intermediate {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @media (max-width: 600px) {
        .modal-content {
          padding: 30px 20px;
        }

        .modal-content h2 {
          font-size: 1.5em;
        }

        .kanji-option {
          padding: 15px 20px;
          font-size: 1em;
        }
      }
    </style>
  </head>
  <body>
    <!-- Modal Selection -->
    <div class="modal" id="kanjiModal">
      <div class="modal-content">
        <h2>üìö Ch·ªçn B·ªô Kanji</h2>
        <p>Ch·ªçn t·∫≠p Kanji b·∫°n mu·ªën h·ªçc</p>
        <div class="kanji-options">
          <button class="kanji-option n3" onclick="selectKanjiSet('n3')">
            üìù JLPT N3 Kanji
            <br />
            <small style="opacity: 0.9">521 H√°n T·ª±</small>
          </button>
          <button class="kanji-option intermediate" onclick="selectKanjiSet('intermediate')">
            üéì Kanji S∆° Trung C·∫•p
            <br />
            <small style="opacity: 0.9">~ 1200 H√°n T·ª±</small>
          </button>
        </div>
      </div>
    </div>

    <div class="container" id="mainContainer" style="display: none">
      <div class="header">
        <h1 id="headerTitle">üìù JLPT N3 Kanji Flashcards</h1>
        <p id="headerSubtitle">521 H√°n T·ª± C·∫ßn Thi·∫øt</p>
      </div>

      <div class="card-container">
        <div class="flashcard" id="flashcard">
          <div class="card-face card-front">
            <!-- Animation Wrapper -->
            <div class="kanji-animation-wrapper">
              <div
                id="kanji-animation"
                class="kanji-svg"
                aria-hidden="true"
              ></div>

              <!-- Animation Controls -->
              <div class="animation-controls">
                <!-- <button class="anim-btn" onclick="animateKanji(event)">
                  ‚ñ∂Ô∏è Animate
                </button> -->
                <button
                  class="anim-btn"
                  onclick="toggleAutoLoop(event)"
                  id="autoLoopBtn"
                >
                  üîÅ Animate
                </button>
              </div>
            </div>

            <!-- Fallback: Static Display -->
            <div class="kanji-display" id="kanji-static">Ë≠∑</div>
          </div>
          <div class="card-face card-back">
            <div class="han-viet" id="han-viet">H·ªò</div>
            <div class="meaning" id="meaning">B·∫£o v·ªá, che ch·ªü</div>
            <div class="example" id="example">
              ÁúãË≠∑Â∏´ („Åã„Çì„Åî„Åó)<br />
              Y t√°
            </div>
            <div class="audio-buttons">
              <button
                class="btn-speak"
                onclick="speakKanjiExample(event)"
                title="ƒê·ªçc t·ª´ v√≠ d·ª• (ch·ªâ ti·∫øng Nh·∫≠t)"
              >
                üîä Nghe
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-prev" onclick="previousCard()">‚óÄ Tr∆∞·ªõc</button>
        <button class="btn btn-flip" onclick="flipCard()">üîÑ L·∫≠t</button>
        <button class="btn btn-next" onclick="nextCard()">Sau ‚ñ∂</button>
      </div>

      <div class="progress">
        <div class="bar">
          <span id="current-card">1</span> / <span id="total-cards">521</span>
        </div>
      </div>

      <div class="flip-hint">
        üí° Nh·∫•p v√†o th·∫ª ho·∫∑c nh·∫•n Spacebar ƒë·ªÉ l·∫≠t | ‚Üê ‚Üí ƒë·ªÉ chuy·ªÉn th·∫ª | A ƒë·ªÉ
        Animate | L ƒë·ªÉ Loop
      </div>
    </div>

    <a href="index.html" class="home-btn">üè† Home</a>

    <style>
      .home-btn {
        position: fixed;
        bottom: 80px;
        right: 25px;
        background-color: #2563eb;
        color: white;
        padding: 12px 18px;
        border-radius: 50px;
        text-decoration: none;
        font-size: 15px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: 0.3s ease;
        z-index: 1000;
      }

      .home-btn:hover {
        background-color: #1d4ed8;
        transform: translateY(-3px);
      }
      .kanji-svg {
        width: 250px;
        height: 250px;
        display: block;
      }

      /* Make SVG responsive inside the container */
      .kanji-svg svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* Stroke default style applied to injected KanjiVG paths */
      .kanji-svg .kanji-stroke {
        fill: none;
        stroke: #e74c3c;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
    </style>

    <script src="./data/tts.js"></script>
    <script>
      let allKanji = [];
      let currentIndex = 0;
      let autoLoop = false;
      let loopInterval = null;
      let currentDataset = ''; // Track which dataset is loaded

      // Cache for fetched SVG text/documents
      const svgCache = new Map();

      // Dataset configuration
      const datasets = {
        'n3': {
          file: './data/kanji.json',
          title: 'üìù JLPT N3 Kanji Flashcards',
          subtitle: '521 H√°n T·ª± C·∫ßn Thi·∫øt',
          count: 521
        },
        'intermediate': {
          file: './data/kanji_intermediate.json',
          title: 'üéì Kanji S∆° Trung C·∫•p Flashcards',
          subtitle: '~ 1200 H√°n T·ª± S∆° Trung C·∫•p',
          count: 1227
        }
      };

      // Show modal on page load
      window.addEventListener('DOMContentLoaded', () => {
        // Check if dataset is in URL params
        const urlParams = new URLSearchParams(window.location.search);
        const dataset = urlParams.get('set');
        
        if (dataset && datasets[dataset]) {
          selectKanjiSet(dataset);
        } else {
          // Show modal
          document.getElementById('kanjiModal').classList.add('show');
        }
      });

      // Select kanji set
      function selectKanjiSet(set) {
        if (!datasets[set]) {
          console.error('Invalid dataset:', set);
          return;
        }

        currentDataset = set;
        
        // Hide modal
        document.getElementById('kanjiModal').classList.remove('show');
        
        // Show main container
        document.getElementById('mainContainer').style.display = 'block';
        
        // Update header
        document.getElementById('headerTitle').textContent = datasets[set].title;
        document.getElementById('headerSubtitle').textContent = datasets[set].subtitle;
        
        // Load data
        loadKanjiData(datasets[set].file, datasets[set].count);
      }

      function codepointHex(character) {
        return Array.from(character)
          .map((c) => c.codePointAt(0).toString(16).toLowerCase())
          .join("-");
      }

      async function fetchKanjiSvg(character) {
        const hex = codepointHex(character);
        const candidates = [
          `./data/kanjivg/0${hex}.svg`,
          `./data/kanjivg/${hex}.svg`,
          `./data/kanjivg/0${encodeURIComponent(character)}.svg`,
        ];

        for (const url of candidates) {
          try {
            // check cache first
            if (svgCache.has(url)) return svgCache.get(url);

            const res = await fetch(url, { cache: "force-cache" });
            if (!res.ok) continue;
            const text = await res.text();
            svgCache.set(url, text);
            console.debug("Loaded KanjiVG from:", url);
            return text;
          } catch (e) {
            continue;
          }
        }

        return null;
      }

      function injectSvgIntoContainer(svgText, container) {
        // Parse SVG text and insert a cloned node into container
        const parser = new DOMParser();
        const doc = parser.parseFromString(svgText, "image/svg+xml");
        const svg = doc.documentElement;

        // Normalize the svg for responsiveness
        svg.removeAttribute("width");
        svg.removeAttribute("height");
        if (!svg.getAttribute("viewBox")) {
          // attempt to build a viewBox from bbox if possible later
        }
        svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
        svg.classList.add("injected-kanji");

        // Ensure strokes are targetable and styled
        const strokeCandidates = svg.querySelectorAll(
          "path, line, polyline, polygon",
        );
        strokeCandidates.forEach((el) => {
          el.classList.add("kanji-stroke");
          try {
            const bg = el.cloneNode(true);
            // Remove kanji-stroke class from background to prevent animation reset
            bg.classList.remove("kanji-stroke");
            bg.classList.add("kanji-stroke-bg"); // Add separate class for background
            bg.style.stroke = "#ddd";
            bg.style.strokeWidth = "4";
            bg.style.fill = "none";
            bg.style.strokeDasharray = "none";
            bg.style.strokeDashoffset = "0";
            bg.style.transition = "none";

            const len = el.getTotalLength ? el.getTotalLength() : 0;
            el.style.strokeDasharray = len;
            el.style.strokeDashoffset = len;
            el.style.transition = "none";
            el.style.fill = "none";
            el.parentNode.insertBefore(bg, el);
          } catch (e) {
            // some elements may not support getTotalLength
          }
        });

        // Clear container and append
        container.innerHTML = "";
        container.appendChild(svg);
        return svg;
      }

      // Animate strokes sequentially using stroke-dashoffset
      function animateSvgStrokes(svg, options = {}) {
        const strokes = Array.from(svg.querySelectorAll(".kanji-stroke"));
        if (strokes.length === 0) return 0;

        const perStrokeBase = options.perStrokeBase || 220; // ms
        const gap = options.gap || 150; // ms between strokes

        let total = 0;
        strokes.forEach((el, idx) => {
          let len = 0;
          try {
            len = el.getTotalLength();
          } catch (e) {
            len = 120;
          }
          const duration = Math.max(
            120,
            Math.round((len / 100) * perStrokeBase),
          );
          const delay = idx === 0 ? 0 : gap;

          const startAt = total + delay;
          // schedule
          setTimeout(() => {
            el.style.transition = `stroke-dashoffset ${duration}ms linear`;
            // trigger reflow to ensure transition
            // eslint-disable-next-line no-unused-expressions
            el.getBoundingClientRect();
            el.style.strokeDashoffset = "0";
          }, startAt);

          total += duration + gap;
        });

        return total;
      }

      async function loadKanjiAnimation(character) {
        const container = document.getElementById("kanji-animation");

        // Clear any running loop
        if (loopInterval) {
          clearInterval(loopInterval);
          loopInterval = null;
        }

        container.innerHTML = "";

        const svgText = await fetchKanjiSvg(character);
        if (!svgText) {
          console.warn("KanjiVG SVG not found for:", character);
          // No static fallback per requirement; show empty placeholder
          container.innerHTML = "";
          return;
        }

        const svg = injectSvgIntoContainer(svgText, container);

        // Auto-animate if requested
        if (autoLoop) {
          const total = animateSvgStrokes(svg);
          // restart loop after animation completes
          loopInterval = setInterval(
            () => {
              // reset
              svg.querySelectorAll(".kanji-stroke").forEach((el) => {
                try {
                  const len = el.getTotalLength();
                  el.style.transition = "none";
                  el.style.strokeDasharray = len;
                  el.style.strokeDashoffset = len;
                } catch (e) {}
              });
              setTimeout(() => animateSvgStrokes(svg), 50);
            },
            Math.max(1000, total + 300),
          );
        }
      }

      function animateKanji(event) {
        if (event) event.stopPropagation();
        const container = document.getElementById("kanji-animation");
        const svg = container.querySelector("svg");
        if (!svg) return;

        // Reset strokes
        svg.querySelectorAll(".kanji-stroke").forEach((el) => {
          try {
            const len = el.getTotalLength();
            el.style.transition = "none";
            el.style.strokeDasharray = len;
            el.style.strokeDashoffset = len;
          } catch (e) {}
        });

        setTimeout(() => animateSvgStrokes(svg), 50);
      }

      function toggleAutoLoop(event) {
        if (event) event.stopPropagation();
        autoLoop = !autoLoop;
        const btn = document.getElementById("autoLoopBtn");
        if (autoLoop) {
          btn.classList.add("active");
          btn.textContent = "‚è∏Ô∏è Stop";
          // start loop for current card
          const container = document.getElementById("kanji-animation");
          const svg = container.querySelector("svg");
          if (svg) {
            const total = animateSvgStrokes(svg);
            loopInterval = setInterval(
              () => {
                svg.querySelectorAll(".kanji-stroke").forEach((el) => {
                  try {
                    const len = el.getTotalLength();
                    el.style.transition = "none";
                    el.style.strokeDasharray = len;
                    el.style.strokeDashoffset = len;
                  } catch (e) {}
                });
                setTimeout(() => animateSvgStrokes(svg), 50);
              },
              Math.max(1000, total + 300),
            );
          }
        } else {
          btn.classList.remove("active");
          btn.textContent = "üîÅ Animate";
          if (loopInterval) {
            clearInterval(loopInterval);
            loopInterval = null;
          }
        }
      }

      // Function to speak only Japanese part of example
      function speakKanjiExample(event) {
        event.stopPropagation();

        const exampleHTML = document.getElementById("example").innerHTML;
        const japaneseOnly = extractJapaneseOnly(exampleHTML);
        if (japaneseOnly) {
          speakJapanese(japaneseOnly, 0.85);
        }
      }

      // Load d·ªØ li·ªáu t·ª´ file JSON
      async function loadKanjiData(filePath, expectedCount) {
        try {
          const response = await fetch(filePath);
          allKanji = await response.json();
          document.getElementById("total-cards").textContent = allKanji.length;
          
          console.log(`‚úÖ Loaded ${allKanji.length} kanji from ${filePath}`);
          
          // Reset to first card
          currentIndex = 0;
          updateCard();
        } catch (error) {
          console.error("Error loading kanji data:", error);
          alert(`‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ ${filePath}`);
        }
      }

      function updateCard() {
        if (allKanji.length === 0) return;

        const card = allKanji[currentIndex];

        // Update back side
        document.getElementById("han-viet").textContent = card.han_viet;
        document.getElementById("meaning").textContent = card.meaning;
        document.getElementById("example").innerHTML = card.example.replace(
          " - ",
          "<br>",
        );
        document.getElementById("current-card").textContent = currentIndex + 1;

        // Load kanji animation on front side
        const chars = card.kanji.split("");
        loadKanjiAnimation(chars[0]);

        // Update static fallback
        document.getElementById("kanji-static").textContent = card.kanji;

        // Reset flip
        document.getElementById("flashcard").classList.remove("flipped");
      }

      function flipCard() {
        document.getElementById("flashcard").classList.toggle("flipped");
      }

      function nextCard() {
        currentIndex = (currentIndex + 1) % allKanji.length;
        updateCard();
      }

      function previousCard() {
        currentIndex = (currentIndex - 1 + allKanji.length) % allKanji.length;
        updateCard();
      }

      // Click to flip (but not on animation controls)
      document
        .getElementById("flashcard")
        .addEventListener("click", function (e) {
          // Don't flip if clicking animation controls or SVG
          if (
            e.target.closest(".animation-controls") ||
            e.target.closest("#kanji-animation")
          ) {
            return;
          }
          flipCard();
        });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === " " || e.key === "Spacebar") {
          e.preventDefault();
          flipCard();
        } else if (e.key === "ArrowLeft") {
          previousCard();
        } else if (e.key === "ArrowRight") {
          nextCard();
        } else if (e.key === "a" || e.key === "A") {
          animateKanji(new Event("click"));
        } else if (e.key === "l" || e.key === "L") {
          toggleAutoLoop(new Event("click"));
        }
      });

      // Data is loaded via modal selection (selectKanjiSet function)
    </script>
  </body>
</html>